define(["exports","lodash","jquery","websockets/binary_websockets","jquery-growl","common/util"],function(e,t,r,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.digits_after_decimal=e.unregister=e.subscribe=e.register=e.keyFor=void 0;var n=i(t),l=i(r),b=i(s);function i(e){return e&&e.__esModule?e:{default:e}}var a=e.keyFor=function(e,t){var r=t||0;return"string"==typeof r&&(r=convertToTimeperiodObject(r).timeInSeconds()),(e+r).toUpperCase()},u=e.register=function(t){var r=this,s=r.keyFor(t.symbol,t.granularity),e=t.granularity||0,i=0!=e&&t.style?t.style:"ticks",n=!0;"string"==typeof e&&("0"===l.default.trim(e)||(e=("1t"===l.default.trim(e).toLowerCase()||(n=!1),convertToTimeperiodObject(e).timeInSeconds())));var a={ticks_history:t.symbol,count:t.count||1,end:"latest",style:i};if(e&&(a.granularity=e),1===t.subscribe&&(a.subscribe=1),!n){var u=t.count||1,c=(new Date).getTime()/1e3-u*e|0,o=new Date;o.setUTCFullYear(o.getUTCFullYear()-3),o.setDate(o.getDate()+1),1e3*c<o.getTime()&&(c=o.getTime()/1e3|0),a.style="candles",a.start=c,a.adjust_start_time=t.adjust_start_time||1}return r[s]={symbol:t.symbol,granularity:e,subscribers:0,chartIDs:[]},a.subscribe&&(r[s].subscribers=1),b.default.send(a,3e4).catch(function(e){if(a.subscribe&&"MarketIsClosed"===e.code)return l.default.growl.notice({message:t.symbol+" market is presently closed.".i18n()}),delete a.subscribe,--r[s].subscribers,b.default.send(a,3e4);throw delete r[s],e})},c=e.subscribe=function(e,t){var r=this;r[e]&&(r[e].subscribers+=1,t&&r[e].chartIDs.push(t))},o=e.unregister=function(e,t){var r=this;if(r[e]){t&&n.default.remove(r[e].chartIDs,{containerIDWithHash:t}),--r[e].subscribers,0===r[e].chartIDs.length&&r[e].timerHandler&&(clearInterval(r[e].timerHandler),r[e].timerHandler=null);var s=r[e].symbol,i=r[r.keyFor(s,0)]&&r[r.keyFor(s,0)].subscribers;0===r[e].subscribers&&r[e].id&&b.default.send({forget:r[e].id}).then(function(){i&&r.register({symbol:s,subscribe:1,count:50})}).catch(function(e){}),0===r[e].subscribers&&delete r[e]}},d=e.digits_after_decimal=function(e){return(e=e&&e+"").substring(e.indexOf(".")+1).length};e.default={keyFor:a,register:u,subscribe:c,unregister:o,digits_after_decimal:d}});