{"version":3,"sources":["../../../../src/charts/chartingRequestMap.es6"],"names":["keyFor","symbol","granularity_or_timeperiod","granularity","convertToTimeperiodObject","timeInSeconds","toUpperCase","register","options","map","key","style","is_tick","$","trim","toLowerCase","req","count","subscribe","start","Date","getTime","_3YearsBack","setUTCFullYear","getUTCFullYear","setDate","getDate","adjust_start_time","subscribers","chartIDs","liveapi","send","catch","up","code","growl","notice","message","i18n","chartID","push","unregister","containerIDWithHash","_","remove","length","timerHandler","clearInterval","instrument","tickSubscribers","id","forget","then","err","console","error","digits_after_decimal","pip","substring","indexOf"],"mappings":"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","file":"chartingRequestMap.js","sourcesContent":["ï»¿/**\n * Created by amin on October 15,2015.\n */\n\n/**\n    Key is instrumentCode+timePeriod(in seconds), Value is\n        {\n            timerHandler : ,\n            chartIDs : [\n                {\n                    containerIDWithHash : containerIDWithHash,\n                    series_compare : series_compare,\n                    instrumentCode : instrumentCode,\n                    instrumentName : instrumentName\n                }\n            ]\n        }\n**/\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport liveapi from 'websockets/binary_websockets';\nimport 'jquery-growl';\nimport 'common/util';\n\nexport const keyFor = (symbol, granularity_or_timeperiod) => {\n    let granularity = granularity_or_timeperiod || 0;\n    if (typeof granularity === 'string') {\n        granularity = convertToTimeperiodObject(granularity).timeInSeconds();\n    }\n    return (symbol + granularity).toUpperCase();\n};\n\n/*  options: {\n      symbol,\n      granularity: // could be a number or a string in 1t, 2m, 3h, 4d format.\n                   // if a string is present it will be converted to seconds\n      subscribe: // default = 1,\n      style: // default = 'ticks',\n      count: // default = 1,\n      adjust_start_time?: // only will be added to the request if present\n    }\n    will return a promise\n*/\nexport const register = function(options) {\n    const map = this;\n    const key = map.keyFor(options.symbol, options.granularity);\n\n    let granularity = options.granularity || 0;\n    //If granularity = 0, then style should be ticks\n    const style = (granularity == 0 || !options.style) ? 'ticks' : options.style;\n\n    let is_tick = true;\n    if (typeof granularity === 'string') {\n        if ($.trim(granularity) === '0') {\n           ;// do nothing\n        } else if ($.trim(granularity).toLowerCase() === '1t') {\n            granularity = convertToTimeperiodObject(granularity).timeInSeconds();\n        } else {\n            is_tick = false;\n            granularity = convertToTimeperiodObject(granularity).timeInSeconds();\n        }\n    }\n\n    const req = {\n        \"ticks_history\": options.symbol,\n        \"count\": options.count || 1,\n        \"end\": 'latest',\n        \"style\": style\n    };\n\n    if (granularity) {\n        req.granularity = granularity;\n    }\n\n    if (options.subscribe === 1) {\n        req.subscribe = 1;\n    }\n\n    if (!is_tick) {\n        const count = options.count || 1;\n        let start = (new Date().getTime() / 1000 - count * granularity) | 0;\n\n        //If the start time is less than 3 years, adjust the start time\n        const _3YearsBack = new Date();\n        _3YearsBack.setUTCFullYear(_3YearsBack.getUTCFullYear() - 3);\n        //Going back exactly 3 years fails. I am adding 1 day\n        _3YearsBack.setDate(_3YearsBack.getDate() + 1);\n\n        if ((start * 1000) < _3YearsBack.getTime()) { start = (_3YearsBack.getTime() / 1000) | 0; }\n\n        req.style = 'candles';\n        req.start = start;\n        req.adjust_start_time = options.adjust_start_time || 1;\n    }\n\n    map[key] = { symbol: options.symbol, granularity: granularity, subscribers: 0, chartIDs: [] };\n    if (req.subscribe) map[key].subscribers = 1; // how many charts have subscribed for a stream\n    return liveapi.send(req, /*timeout:*/ 30 * 1000) // 30 second timeout\n        .catch((up) => {\n            /* if the market is closed try the same request without subscribing */\n            if (req.subscribe && up.code === 'MarketIsClosed') {\n                $.growl.notice({ message: options.symbol + ' market is presently closed.'.i18n() });\n                delete req.subscribe;\n                map[key].subscribers -= 1;\n                return liveapi.send(req, 30 * 1000);\n            }\n            delete map[key];\n            throw up;\n        });\n}\n\n/* use this method if there is already a stream with this key registered,\n  if you are counting on a registered stream and don't call this method that stream might be removed,\n  when all dependent modules call unregister function.\n  you should also make sure to call unregister when you no longer need the stream to avoid \"stream leack!\" */\nexport const subscribe = function(key, chartID) {\n    const map = this;\n    if (!map[key]) {\n        return;\n    }\n    map[key].subscribers += 1;\n    if (chartID) {\n        map[key].chartIDs.push(chartID);\n    }\n}\n\nexport const unregister = function(key, containerIDWithHash) {\n    const map = this;\n    if (!map[key]) {\n        return;\n    }\n    if (containerIDWithHash) {\n        _.remove(map[key].chartIDs, { containerIDWithHash: containerIDWithHash });\n    }\n    map[key].subscribers -= 1;\n    if (map[key].chartIDs.length === 0 && map[key].timerHandler) {\n        clearInterval(map[key].timerHandler);\n        map[key].timerHandler = null;\n    }\n    /* Remove the following code if backend fixes this issue: \n     * https://trello.com/c/1IZRihrH/4662-1-forget-call-for-one-stream-id-affects-all-other-streams-with-the-same-symbol\n     * Also remove instrument from function argument list.\n     */\n    //-----Start-----//\n    const instrument = map[key].symbol;\n    const tickSubscribers = map[map.keyFor(instrument, 0)] && map[map.keyFor(instrument, 0)].subscribers;\n    //-----End-----//\n    if (map[key].subscribers === 0 && map[key].id) { /* id is set in stream_handler.js */\n        liveapi.send({ forget: map[key].id })\n            // Remove this part as well.\n            .then(()=>{\n                // Resubscribe to tick stream if there are any tickSubscribers.\n                if (tickSubscribers)\n                    map.register({\n                        symbol: instrument,\n                        subscribe: 1,\n                        count: 50 // To avoid missing any ticks.\n                    });\n            })\n            .catch((err) => { console.error(err); });\n    }\n    if (map[key].subscribers === 0) {\n        delete map[key];\n    }\n};\n\nexport const digits_after_decimal = function(pip, symbol) {\n    pip = pip && pip + '';\n    return pip.substring(pip.indexOf(\".\") + 1).length;\n};\n\nexport default {\n    keyFor,\n    register,\n    subscribe,\n    unregister,\n    digits_after_decimal\n};\n"]}