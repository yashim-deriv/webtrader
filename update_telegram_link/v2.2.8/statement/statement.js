define(["exports","jquery","../windows/windows","../websockets/binary_websockets","lodash","text!./statement.html","../viewtransaction/viewTransaction","datatables","jquery-growl","css!./statement.css"],function(t,e,a,n,i,o,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0;var l=h(e),r=h(a),d=h(n),c=h(i),u=h(o),f=h(s);function h(t){return t&&t.__esModule?t:{default:t}}function m(t){var i=(0,l.default)("#"+p.attr("id")+"_processing").css("top","200px").show(),e={statement:1,description:1};if("string"==typeof t){e.date_from=yearMonthDayToEpoch(t,{utc:!0});var a=Date.UTC(1970,0,1,23,59,59)/1e3;e.date_to=e.date_from+a,p.api().rows().remove(),_=!0}else e.limit=250,(_||t&&t.clear)&&(p.api().rows().remove(),_=!1),e.offset=p.api().column(0).data().length;function n(t){var e=t.statement&&t.statement.transactions||[],n="View".i18n(),a=e.map(function(t){var e=(0,c.default)(["buy","sell"]).includes(t.action_type)?"":"button-disabled",a='<button class="'+(e=(0,c.default)(["deposit","withdrawal"]).includes(t.action_type)?"invisible":e)+'">'+n+"</button>";t.amount;return[epochToString(t.transaction_time,{utc:!0}),t.transaction_id,c.default.capitalize(t.action_type),t.longcode,+t.amount,"<b>"+formatPrice(t.balance_after,local_storage.get("currency"))+"</b>",a,t]});p.api().rows.add(a),p.api().draw(),w=!1,0===t.statement.count&&(y=!0),i.hide()}w||(w=!0,d.default.send(e).then(n).catch(function(t){n({}),l.default.growl.error({message:t.message}),w=!1}))}var g=null,p=null,b=null,v=t.init=function(t){t.click(function(){g?g.moveToTop():d.default.cached.authorize().then(T).catch(function(t){})})},w=!1,_=!1,y=!1,T=function(){y=!1,(g=r.default.createBlankWindow((0,l.default)("<div/>"),{title:"Statement".i18n(),dialogClass:"statement",width:800,height:400,close:function(){p&&p.DataTable().destroy(!0),g&&g.remove(),g=null},refresh:function(){b.clear(),m({clear:!0})},"data-authorized":"true"})).track({module_id:"statement",is_unique:!0,data:null}),(p=(0,l.default)(u.default).i18n()).appendTo(g),(p=p.dataTable({data:[],autoWidth:!1,columnDefs:[{targets:3,width:"35%"},{targets:4,createdCell:function(t,e){var a=e<0?"red":0<e?"green":"bold";a&&(0,l.default)(t).addClass(a),t.innerHTML=formatPrice(e,local_storage.get("currency"))}}],paging:!1,ordering:!1,searching:!0,processing:!0})).closest(".ui-dialog-content").addClass("hide-search-input").addClass("statement-dialog-content"),p.api().columns().every(function(){var t=this;(0,l.default)("input",this.header()).on("keyup change",function(){t.search()!==this.value&&t.search(this.value).draw()})}),b=g.addDateToHeader({title:"Jump to: ",date:null,changed:m,cleared:m}),g.on("click",C),g.dialog("open"),m({clear:!0}),g.scroll(function(){.75<(g.scrollTop()+g.innerHeight())/g[0].scrollHeight&&!w&&!_&&!y&&m({clear:!1})})},C=function(t){var e=t.target,a=(0,l.default)(e);if("BUTTON"===e.tagName&&!a.hasClass("button-disabled")){var n=e.parentElement.parentElement,i=p.api().row(n).data();i=c.default.last(i),a.addClass("button-disabled"),f.default.init(i.contract_id,i.transaction_id).then(function(){return a.removeClass("button-disabled")}).catch(function(t){a.removeClass("button-disabled"),l.default.growl.error({message:t.message})})}};t.default={init:v}});