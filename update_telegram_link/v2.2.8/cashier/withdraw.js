define(["exports","jquery","websockets/binary_websockets","windows/windows","common/rivetsExtra","cashier/uk_funds_protection","text!cashier/withdraw.html"],function(t,e,n,i,a,o,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=d(e),f=d(n),u=d(i),m=d(a),g=d(o),r=d(c);function d(t){return t&&t.__esModule?t:{default:t}}require(["text!cashier/withdraw.html"]),require(["css!cashier/withdraw.css"]);function h(t){s.default.growl.error({message:t.message})}var v=null,p=null;t.default=new function t(){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.init=function(t){t.click(function(){v?v.moveToTop():f.default.cached.authorize().then(function(){n._init_win(r.default)}).catch(h)})},this._init_win=function(t){t=(0,s.default)(t).i18n(),v=u.default.createBlankWindow(t,{title:"Withdraw funds",resizable:!0,collapsable:!1,minimizable:!0,maximizable:!0,width:700,height:400,"data-authorized":!0,close:function(){v.trigger("dialogclose"),v.remove(),v=null},open:function(){},destroy:function(){p&&p.unbind(),p=null}}),n._init_state(t),v.dialog("open");var e=v.dialog("widget").offset();e.top=110,v.dialog("option","position",{my:e.left,at:e.top}),v.dialog("widget").css({left:e.left+"px",top:e.top+"px"}),v.track({module_id:"withdraw",is_unique:!0})},this._init_state=function(t){var n={clear:_.debounce(function(t,e){t[e]=!1},4e3),route:{value:"menu"},empty_fields:{validate:!1,token_length:!1,show:function(){n.empty_fields.validate=!0,n.clear(n.empty_fields,"validate")}},validate:{invalid_length:!1,invalid_text:!1,length:function(){return 8==n.verify.token.length||(n.validate.invalid_length=!0,n.clear(n.validate,"invalid_length"),!1)},text:function(){return!/[^1-9a-zA-Z'\- ,.]/g.test(n.agent.instructions)||(n.validate.invalid_text=!0,n.clear(n.validate,"invalid_text"),!1)}},menu:{choice:""},verify:{token:"",code:"",disabled:!1},transfer:{disabled:!1,account:"",amount:"",loginid:local_storage.get("authorize").loginid,value:[]},standard:{url:"",iframe_visible:!1},agent:{disabled:!1,loginid:"",name:"",agents:[],commission:"",amount:"",min_amount:"",max_amount:"",hint:"",currency:local_storage.get("authorize").currency,residence:"",instructions:"",checkAmount:function(t,e){var n=e.agent.amount;""!==n&&(n>e.agent.max_amount&&(e.agent.amount=e.agent.max_amount),n<0&&(e.agent.amount=""))}},login_details:loginids().reduce(function(t,e){return t.id===local_storage.get("authorize").loginid?t:e})},i=n.route,a=n.menu,e=n.verify,o=n.empty_fields,c=n.standard,u=n.agent,r=n.transfer,d=n.validate,l={menu:400,verify:400,transfer:400,"transfer-done":300,standard:400,agent:550,"agent-confirm":400,"agent-done":300};i.update=function(t){i.value=t,v.dialog("option","height",l[t])},a.click=function(t){if(a.choice=t,i.update("transfer"!==t?"verify":"transfer"),"transfer"!==t){var e=local_storage.get("authorize").email,n="agent"===t?"paymentagent_withdraw":"payment_withdraw";!isCryptoCurrency(u.currency)||"DAI"===u.currency&&"UST"===u.currency?(u.min_amount=10,u.max_amount=2e3):(u.min_amount=.002,u.max_amount=5),u.hint=("Min: "+u.min_amount+" Max: "+u.max_amount).i18n(),f.default.send({verify_email:e,type:n}).then(function(){return s.default.growl.notice({message:"Verification code sent to ".i18n()+e})}).catch(function(t){h(t),i.update("menu")})}},e.back=function(){e.token=e.code="",i.update("menu")},e.unlock=function(){e.token?d.length()&&("standard"===a.choice?(e.disabled=!0,f.default.send({cashier:"withdraw",verification_code:e.token}).then(function(t){if(t.cashier.startsWith("ASK_"))throw new Error(t.cashier);c.url=t.cashier,e.disabled=!1,i.update("standard"),e.code=e.token,e.token=""}).catch(function(t){e.disabled=!1,"ASK_UK_FUNDS_PROTECTION"!==t.code?h(t):g.default.init_win().then().catch(function(t){h(t)})})):"agent"===a.choice&&(e.code=e.token,e.token="",i.update("agent"))):o.show()},c.iframe_loaded=function(){c.url&&(c.iframe_visible=!0)},u.onchanged=function(){if(u.loginid){var t=u.agents.find(function(t){return t.paymentagent_loginid===u.loginid}),e=t.withdrawal_commission,n=t.name;u.commission=e,u.name=n}else u.commission="",u.name=""},u.amount_with_commission=function(){return((u.amount||0)*(100-u.commission)/100).toFixed(2)},u.click=function(){u.loginid?u.amount>=u.min_amount&&u.amount<=u.max_amount?u.instructions&&!d.text()||i.update("agent-confirm"):s.default.growl.error({message:("Amount Min: "+u.min_amount+" Max: "+u.max_amount).i18n()}):s.default.growl.error({message:"Please select a payment agent".i18n()})},u.confirm_transfer=function(){var t={paymentagent_withdraw:1,paymentagent_loginid:u.loginid,currency:u.currency,amount:+u.amount,description:u.instructions,verification_code:e.code};u.disabled=!0,f.default.send(t).then(function(t){i.update("agent-done"),u.disabled=!1}).catch(function(t){u.disabled=!1,i.update("menu"),h(t)})},r.submit=function(){if(""!==r.account&&""!==r.amount){var t={transfer_between_accounts:1,account_from:r.account.split("_to_")[0],account_to:r.account.split("_to_")[1],currency:u.currency,amount:r.amount};r.disabled=!0,f.default.send(t).then(function(t){r.account=r.account.split("_to_")[1],i.update("transfer-done")}).catch(function(t){h(t),r.disabled=!1})}else o.show()},r.isAvailable=function(){if(n.login_details.is_mlt||n.login_details.is_mf){var e=!0;return loginids().forEach(function(t){t.id!==n.login_details.id&&(t.is_mf||t.is_mlt)&&(e=!1,r.value=[{value:n.login_details.id+"_to_"+t.id,text:"from account ("+n.login_details.id+") to account ("+t.id+")"}],r.value.push({value:t.id+"_to_"+n.login_details.id,text:"from account ("+t.id+") to account ("+n.login_details.id+")"}),r.account=r.value[0].value)}),!e}},f.default.cached.send({get_settings:1}).then(function(t){u.residence=t.get_settings.country_code;var e=local_storage.get("currency");return f.default.cached.send({paymentagent_list:u.residence,currency:e})}).then(function(t){u.agents=t.paymentagent_list.list}).catch(h),f.default.send({payout_currencies:1}).then(function(t){u.currency=t.payout_currencies[0]}).catch(function(t){}),p=m.default.bind(t[0],n)}}});