define(["exports","jquery","text!../oauth/app_id.json","common/util"],function(e,t,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.sell_expired=e.is_authenticated=e.send=e.cached=e.switch_account=e.execute=e.proposal_open_contract=e.events=e.invalidate=e.server_url=e.app_id=e.socket_url=void 0;var i=r(t),a=r(n);function r(e){return e&&e.__esModule?e:{default:e}}function o(){return localStorage.getItem("config.server_url")||"frontend.binaryws.com"}function s(){var e=(local_storage.get("i18n")||{value:"en"}).value,t=new WebSocket(g+"?l="+e+"&app_id="+v);return t.addEventListener("open",q),t.addEventListener("close",m),t.addEventListener("message",O),t.addEventListener("error",function(e){i.default.growl.error({message:"Connection error.".i18n()}),m()}),t}function c(){return f&&1===f.readyState}var u=!1,l=void 0,f=null,d=!1,_={},g=e.socket_url="wss://"+o()+"/websockets/v3",v=e.app_id=localStorage.getItem("config.app_id")||function(){var e=JSON.parse(a.default),t=window.location.href,n="";for(var r in e)if(0===t.lastIndexOf(r,0)){n=e[r];break}var o=n||11;return localStorage.setItem("config.app_id",o),o}(),h=e.server_url=o(),p=!1,m=function(){require(["windows/tracker"],function(e){var t=e.get_trade_dialogs(),n=e.get_unique_dialogs();u=!1,N("logout"),p||(p=!0,setTimeout(function(){p=!1,f=s(),local_storage.get("oauth")&&L.cached.authorize().then(function(){e.reopen_trade_dialogs(t),setTimeout(function(){return e.reopen_unique_dialogs(n)},0)}).catch(function(e){i.default.growl.error({message:e.message})})},1e3))})},b={},w=[],y=[],x={},S={},q=function(){for(f.send(JSON.stringify({website_status:1,subscribe:1}));0<y.length;){var e=y.shift();x[e.req_id]||f.send(JSON.stringify(e))}for(var t in x){var n=x[t];n&&(n.sent_before?n.reject({message:"Connection closed.".i18n()}):(n.sent_before=!0,f.send(JSON.stringify(n.data))))}for(;0<w.length;)w.shift()()},O=function(e){var n=JSON.parse(e.data);b[n.msg_type]=b[n.msg_type]||[];for(var t=function(e){var t=b[n.msg_type][e];setTimeout(function(){return t(n)},0)},r=0;r<b[n.msg_type].length;r++)t(r);var o=n.req_id,i=x[o]||_[o];i&&(delete x[o],delete _[o],n.error?(n.error.echo_req=n.echo_req,n.error.req_id=n.req_id,i.reject(n.error)):i.resolve(n))};f=s();function j(e){for(var t in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1,get_self_exclusion:1,set_self_exclusion:1})if(t in e)return 1}function k(n){return n.req_id=++z,new Promise(function(e,t){d?(x[n.req_id]={resolve:e,reject:t,data:n},c()?f.send(JSON.stringify(n)):y.push(n)):_[n.req_id]={resolve:e,reject:t,data:n}})}function T(e){var r=!1,o={authorize:e},i=JSON.stringify(o),a=k(o);return(l=a).then(function(e){u=!0,l=void 0,local_storage.set("authorize",e.authorize);var t=-1!==e.authorize.landing_company_name.indexOf("japan");if(t||setTimeout(function(){return N("login",e)}),local_storage.get("oauth-login")){var n=local_storage.get("oauth-login").value;local_storage.remove("oauth-login"),n&&!t&&setTimeout(function(){return N("oauth-login",e)})}return r=!0,S[i]={data:o,promise:a},e}).catch(function(e){throw"SelfExclusion"===e.code||r||(u=!1,setTimeout(function(){return N("logout")}),local_storage.remove("oauth")),l=void 0,delete S[i],e})}var z=0,J=e.invalidate=function(){for(var e in local_storage.remove("oauth"),local_storage.remove("authorize"),N("reset_realitycheck"),N("reset_accountstatus"),L.send({logout:1}).catch(function(e){i.default.growl.error({message:e.message}),f.close()}),S)(j(S[e].data)||"authorize"in S[e].data)&&delete S[e];u=!1},N=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];(b[e]||[]).forEach(function(e){setTimeout(function(){return e.apply(void 0,n)},0)})},P={},E={},I={},L={events:e.events={on:function(e,t){return(b[e]=b[e]||[]).push(t),t},off:function(e,t){if(b[e]){var n=b[e].indexOf(t);-1!==n&&b[e].splice(n,1)}},on_till:function(t,n){L.events.on(t,function e(){n.apply(void 0,arguments)&&L.events.off(t,e)})}},proposal_open_contract:e.proposal_open_contract={subscribe:function(t){if(E[t]&&0<E[t].subscribers)return E[t].subscribers++,E[t].promise;var e=L.send({proposal_open_contract:1,contract_id:t,subscribe:1}).then(function(e){return E[t].stream_id=e.proposal_open_contract.id,e}).catch(function(e){throw E[t]=void 0,e});return E[t]={subscribers:1,promise:e},e},forget:function(t){var n=E[t],e=I[t];if(!n)return e||Promise.resolve();if(0==n.subscribers)return e;if(n.subscribers--,0<n.subscribers)return Promise.resolve();function r(){return E[t]=void 0,L.send({forget:n.stream_id}).catch(function(e){throw I[t]=void 0,e}).then(function(e){return I[t]=void 0,e}).catch(function(e){i.default.growl.error({message:e.message})})}return n.stream_id?I[t]=r():I[t]=n.promise.catch(function(e){}).then(function(e){return n.stream_id?r():void 0}).catch(function(e){i.default.growl.error({message:e.message})}),I[t]}},execute:e.execute=function(e){c()?setTimeout(e,0):w.push(e)},switch_account:e.switch_account=function(e){var t=local_storage.get("oauth");if(!t)return Promise.reject({message:"Account token not found.".i18n()});var n=t.map(function(e){return e.id}).indexOf(e);if(-1===n)return promise.reject({message:"Account id not found.".i18n()});var r=t[n];for(var o in t.splice(n,1),t.unshift(r),local_storage.set("oauth",t),S)(j(S[o].data)||"authorize"in S[o].data)&&delete S[o];return u=!1,L.send({forget_all:"transaction"}).catch(function(e){}),L.send({forget_all:"balance"}).catch(function(e){}),L.cached.authorize().then(function(e){return N("switch_account",e)}).catch(function(e){i.default.growl.error({message:e.message})})},cached:e.cached={send:function(e){var t=JSON.stringify(e);return S[t]?S[t].promise:(S[t]={data:e,promise:null},S[t].promise=L.send(e).then(function(e){return e},function(e){throw delete S[t],e}).catch(function(e){i.default.growl.error({message:e.message})}))},authorize:function(e){var t=local_storage.get("oauth"),n=t&&t[0]&&t[0].token,r=JSON.stringify({authorize:n});return u&&n&&S[r]&&!e?S[r].promise:l||(n?T(n):Promise.reject("Please log in.".i18n()))}},send:e.send=function(e,t){if(e&&j(e))return function(e){if(u)return k(e);var t=k.bind(null,e);if(local_storage.get("oauth")){var n=local_storage.get("oauth")[0].token;return T(n).then(t).catch(function(e){i.default.growl.error({message:e.message})})}return Promise.reject({message:"Please log in".i18n()})}(e);var n,r=k(e);return t&&(n=e.req_id,setTimeout(function(){var e=x[n];e&&(delete x[n],e.reject({message:"Timeout for websocket request".i18n()}))},t)),r},is_authenticated:e.is_authenticated=function(){return u},sell_expired:e.sell_expired=function(e){var t=(new Date).getTime()/1e3|0;!P[e=e||1+t]&&t<+e&&(P[e]=setTimeout(function(){P[e]=void 0,L.send({sell_expired:1}).catch(function(e){})},1e3*(e+2-t)))},invalidate:J,app_id:v,socket_url:g,server_url:h};L.events.on("website_status",function(e){if(d=e.website_status&&"up"===e.website_status.site_status.toLowerCase())for(var t in _)_[t].is_sent||(f.send(JSON.stringify(_[t].data)),_[t].is_sent=1)}),L.events.on("login",function(){L.send({transaction:1,subscribe:1}).catch(function(e){}),L.send({balance:1,subscribe:1}).catch(function(e){})}),L.events.on("logout",function(){L.send({forget_all:"transaction"}).catch(function(e){}),L.send({forget_all:"balance"}).catch(function(e){})}),setInterval(function(){return L.send({ping:1})},3e4),e.default=L});