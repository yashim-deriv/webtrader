define(["exports","babel-runtime/regenerator","jquery","../windows/windows","../websockets/binary_websockets","jquery-ui","datatables","jquery-growl","css!./portfolio.css"],function(e,t,n,a,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.proposal_open_contract=e.init=void 0;var i=l(t),c=l(n),o=l(a),s=l(r);function l(e){return e&&e.__esModule?e:{default:e}}function u(e){return function(){var c=e.apply(this,arguments);return new Promise(function(o,i){return function t(e,n){try{var a=c[e](n),r=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(r).then(function(e){t("next",e)},function(e){t("throw",e)});o(r)}("next")})}}function d(e){if(!e.error){var t=e.proposal_open_contract,n=t.contract_id,a=t.bid_price;if(p){var r=p.api().row("#"+n),o=r.data();if(!o)return;var i=o[3];o[3]=a,r.data(o);var c=p.find("#"+n);t.is_valid_to_sell?(c.removeClass("resale-not-offered"),i!==a&&c.removeClass("indicative-red indicative-green").addClass(+i<+a?"indicative-green":"indicative-red")):c.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}}var f=null,p=null,b=null,v=[],g=e.init=function(e){e.click(function(){f?f.moveToTop():x()})},h=!1,m=0;s.default.events.on("logout",function(){h=!1,m=0});function w(e){if("subscribe"===e)++m,!h&&0<m&&s.default.send({proposal_open_contract:1,subscribe:1}).then(function(e){h=!0}).catch(function(e){c.default.growl.error({message:e.message})});else if("forget"===e)--m,h&&0===m&&s.default.send({forget_all:"proposal_open_contract"}).then(function(e){h=!1}).catch(function(e){h=!1});else{if("resubscribe"!==e)return;s.default.send({forget_all:"proposal_open_contract"}).then(function(e){h=!1,--m,w("subscribe")}).catch(function(e){h=!1})}}function y(e){var t=e.target,n=(0,c.default)(t);if("BUTTON"===t.tagName&&!n.hasClass("button-disabled")){var a=t.parentElement.parentElement,r=p.api().row(a).data();r=_.last(r),n.addClass("button-disabled"),require(["viewtransaction/viewTransaction"],function(e){e.init(r.contract_id,r.transaction_id).then(function(){return n.removeClass("button-disabled")}).catch(function(e){n.removeClass("button-disabled"),c.default.growl.error({message:e.message})})})}}var C,x=function(){var n="",a=s.default.events.on("balance",function(e){void 0!==e.balance&&void 0!==e.balance.currency&&(n=e.balance.currency,b&&b&&b.update(e.balance.balance))}),r=(local_storage.get("i18n"),local_storage.get("active_symbols"),s.default.events.on("transaction",function(e){var t=e.transaction;if("buy"===t.action){var n="<button>View</button>".i18n(),a=[t.transaction_id,t.longcode,Math.abs(t.amount),"0.00",n,t.contract_id,t];t.date_expiry&&s.default.sell_expired(t.date_expiry),p.api().rows.add([a]),p.api().draw(),P([t])}else if("sell"===t.action){var r=p.find("#"+t.contract_id)[0];p.api().row(r).remove(),p.api().draw(),k([t])}}));s.default.send({balance:1}).then(function(e){n=e.balance.currency;var t=(f=o.default.createBlankWindow((0,c.default)("<div/>"),{title:"Portfolio".i18n(),dialogClass:"portfolio",width:700,height:400,"data-authorized":"true",close:function(){k(v),s.default.events.off("proposal_open_contract",d)},open:function(){T(),s.default.events.on("proposal_open_contract",d)},destroy:function(){p&&p.DataTable().destroy(!0),f=null,s.default.events.off("balance",a),s.default.events.off("transaction",r)},refresh:function(){s.default.send({balance:1}).catch(function(e){c.default.growl.error({message:e.message})}),k(v).then(T)}})).parent().find(".ui-dialog-title").addClass("with-content");(b=(0,c.default)('<span class="span-in-dialog-header" />').insertAfter(t)).update=function(e){b.html("Account balance: <strong>".i18n()+formatPrice(e,n)+"</strong>")},(p=(0,c.default)("<table width='100%' class='portfolio-dialog hover'/>")).appendTo(f),(p=p.dataTable({data:[],columns:[{title:"Ref.".i18n()},{title:"Contract Details".i18n()},{title:"Purchase".i18n(),render:function(e){return'<span class="bold">'+formatPrice(e,n)+"</span>"}},{title:"Indicative".i18n(),render:function(e){return'<span class="bold">'+formatPrice(e,n)+"</span>"}},{title:""}],rowId:"5",paging:!1,ordering:!1,processing:!0})).parent().addClass("hide-search-input"),f.on("click",y),f.track({module_id:"portfolio",is_unique:!0,data:null}),f.dialog("open")}).catch(function(e){})},P=function(e){e.forEach(function(e){v.push(e),s.default.proposal_open_contract.subscribe(e.contract_id).catch(function(e){})})},k=function(e){var t=e.map(function(e){return s.default.proposal_open_contract.forget(e.contract_id).catch(function(e){return c.default.growl.error({message:e.message})})}),n=_.map(e,"contract_id");return v=v.filter(function(e){return!1===_.includes(n,e.contract_id)}),Promise.all(t)},T=(C=u(i.default.mark(function e(){var t,n,a,r,o;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,c.default)("#"+p.attr("id")+"_processing").show(),e.prev=1,e.next=4,s.default.send({portfolio:1});case 4:n=e.sent,a=n.portfolio&&n.portfolio.contracts,r="<button>View</button>".i18n(),o=a.map(function(e){return[e.transaction_id,e.longcode,e.buy_price,"0.00",r,e.contract_id,e]}),a.forEach(function(e){return s.default.sell_expired(e.expiry_time)}),P(a),p.api().rows().remove(),p.api().rows.add(o),p.api().draw(),t.hide(),e.next=23;break;case 16:e.prev=16,e.t0=e.catch(1),p.api().rows().remove(),p.api().draw(),t.hide(),c.default.growl.error({message:e.t0.message});case 23:case"end":return e.stop()}},e,void 0,[[1,16]])})),function(){return C.apply(this,arguments)}),q=e.proposal_open_contract={subscribe:function(){return w("subscribe")},forget:function(){return w("forget")},resubscribe:function(){return w("resubscribe")}};e.default={init:g,proposal_open_contract:q}});