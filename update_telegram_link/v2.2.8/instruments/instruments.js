define(["exports","jquery","websockets/binary_websockets","navigation/menu","charts/chartWindow","../common/marketUtils","jquery-growl","common/util"],function(e,t,a,n,r,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getSpecificMarketData=e.isMarketDataPresent=e.getMarketData=e.init=void 0;var i=l(t),u=l(a),m=l(n),o=l(r);function l(e){return e&&e.__esModule?e:{default:e}}function c(){u.default.send({active_symbols:"brief"}).then(function(e){var r=[];local_storage.set("active_symbols",e.active_symbols);var t=_(e.active_symbols).groupBy("market").map(function(e){var t=e,a=_.head(t),n={name:a.market,display_name:a.market_display_name};return n.submarkets=_(t).groupBy("submarket").map(function(e){var t=_.head(e),a={name:t.submarket,display_name:t.submarket_display_name};return a.instruments=_.map(e,function(e){return r.push(e.symbol),{symbol:e.symbol,display_name:e.display_name}}),a}).value(),n}).value();k=g.map(function(e){return{display_name:e.display_name,name:e.name,submarkets:e.submarkets.map(function(e){return{display_name:e.display_name,instruments:e.instruments.filter(function(e){return-1!==r.indexOf(e.symbol)})}}).filter(function(e){return 0!==e.instruments.length})}}).filter(function(e){return 0!==e.submarkets.length}),k=(0,s.getSortedMarketSubmarkets)(t);var a=(0,i.default)("#nav-menu").find(".instruments");a.find("> ul").remove(),m.default.refreshMenu(a,k,f)}).catch(function(e){i.default.growl.error({message:e.message})})}function d(){local_storage.get("oauth")?u.default.cached.authorize().then(function(){var e=local_storage.get("authorize").country;u.default.cached.send({landing_company:e}).then(function(e){e.landing_company;c()})}).catch(function(e){i.default.growl.error({message:e.message})}):c()}function f(e,t){o.default.addNewWindow({instrumentCode:e,instrumentName:t,timePeriod:"1d",type:"candlestick"})}var k=[],g=[],y=e.init=function(){return u.default.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(e){return g=m.default.extractChartableMarkets(e),d(),u.default.events.on("login",d),u.default.events.on("logout",d),g})},p=e.getMarketData=function(){return k},b=e.isMarketDataPresent=function(a,e){var n=!1;e=e||k;var r=this;return i.default.each(e,function(e,t){return t.submarkets||t.instruments?n=r.isMarketDataPresent(a,t.submarkets||t.instruments):i.default.trim(t.display_name)==i.default.trim(a)&&(n=!0),!n}),n},h=e.getSpecificMarketData=function(a,e){var n={};e=e||k;var r=this;return i.default.each(e,function(e,t){return t.submarkets||t.instruments?n=r.getSpecificMarketData(a,t.submarkets||t.instruments):i.default.trim(t.display_name)==i.default.trim(a)&&(n=t),i.default.isEmptyObject(n)}),n};e.default={init:y,getMarketData:p,isMarketDataPresent:b,getSpecificMarketData:h}});