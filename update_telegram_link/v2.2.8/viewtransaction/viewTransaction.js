define(["exports","jquery","windows/windows","websockets/binary_websockets","charts/chartingRequestMap","common/rivetsExtra","moment","../charts/chartSettings","trade/lookback","common/util"],function(t,e,r,o,a,i,n,c,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0;var d=u(e),s=u(r),h=u(o),m=u(a),p=u(i),y=u(n),g=function(t){{if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e}}(c),_=u(l);function u(t){return t&&t.__esModule?t:{default:t}}var f=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},v=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var r=[],o=!0,a=!1,i=void 0;try{for(var n,c=t[Symbol.iterator]();!(o=(n=c.next()).done)&&(r.push(n.value),!e||r.length!==e);o=!0);}catch(t){a=!0,i=t}finally{try{!o&&c.return&&c.return()}finally{if(a)throw i}}return r}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")};require(["css!viewtransaction/viewTransaction.css"]),require(["text!viewtransaction/viewTransaction.html"]);function b(t,r){var e,o,a,i,n=t.proposal_open_contract;o=r,a=(e=n).is_path_dependent&&"sold"!==e.status?e.exit_tick_time:parseInt(e.sell_time),i=getSymbolPipValue(e.underlying),o.proposal_open_contract.pip=i,o.proposal_open_contract.is_sold_before_expiry=a<e.date_expiry,o.proposal_open_contract.current_spot=e.current_spot,o.proposal_open_contract.current_spot_time=e.current_spot_time,o.proposal_open_contract.bid_price=e.bid_price,o.proposal_open_contract.entry_tick=e.entry_tick,o.proposal_open_contract.entry_tick_time=e.entry_tick_time,o.proposal_open_contract.status=e.status,o.proposal_open_contract.is_sold=e.is_sold,o.proposal_open_contract.exit_tick=e.exit_tick,o.proposal_open_contract.exit_tick_time=e.exit_tick_time,o.proposal_open_contract.date_expiry=e.date_expiry,o.proposal_open_contract.sell_price=e.sell_price,o.proposal_open_contract.is_valid_to_sell=e.is_valid_to_sell,o.proposal_open_contract.barrier=e.barrier,o.proposal_open_contract.high_barrier=e.high_barrier,o.proposal_open_contract.low_barrier=e.low_barrier,o.note=T(e),function(t,e){z(t,e);var r=e.chart.chart;if(!r)return;(function(t,n,c){var e=t.entry_tick_time,r=t.exit_tick_time,o=t.tick_count,a=t.is_path_dependent,i=n.proposal_open_contract.is_sold_before_expiry;if(o)return;e&&l({spot_time:e,label:"entry_tick_time",color:"white"});a&&r&&l({spot_time:r,label:"exit_tick_time",color:"orange"});i||l({spot_time:r,label:"exit_tick_time",color:"orange"});function l(t){var e=t.spot_time,r=t.label,o=t.color;if(e&&!n.chart.hasLabel(r)){var a=c.series[0].data.find(function(t){return+t.x==1e3*e});if(a){var i=g.getMarkerSettings(o);a.update({marker:i})}}}})(t,e,r),function(t,i,n){var e=t.entry_tick_time,o=t.exit_tick_time,r=t.date_start,a=t.date_expiry,c=t.tick_count,l=t.sell_time;if(c)return s({line_time:e,label:"start_time"}),s({line_time:o,label:"end_time",dashStyle:"Dash"});function s(t){var e=t.line_time,r=t.label,o=t.dashStyle,a=t.color;e&&!i.chart.hasLabel(r)&&n.addPlotLineX({value:1e3*e,dashStyle:o,color:a})}s({line_time:r,label:"start_time"}),function(t){var e=t.is_path_dependent,r=i.proposal_open_contract.is_sold_before_expiry;e&&o&&r&&s({line_time:o,label:"end_time",dashStyle:"Dash"}),r&&s({line_time:l,label:"end_time",dashStyle:"Dash"}),e||s({line_time:a,label:"end_time",dashStyle:"Dash"})}(t),function(t){var e=t.purchase_time;e<r&&s({line_time:e,label:"purchase_time",color:"#7cb5ec"})}(t)}(t,e,r),C(t,e),function(t,a,i){var e=t.entry_tick_time,r=t.exit_tick_time,o=t.date_expiry,n=t.sell_time,c=a.proposal_open_contract.is_sold_before_expiry;l({spot_time:e,label:"entry_zone",zone_idx:0}),c&&l({spot_time:r||n,label:"exit_zone",zone_idx:1});function l(t){var e=t.spot_time,r=t.label,o=t.zone_idx;e&&!a.chart.hasLabel(r)&&(i.series[0].zones[o].value=1e3*e)}l({spot_time:r||o,label:"exit_zone",zone_idx:1})}(t,e,r)}(n,r),"open"!==n.status?L(r):(function(){if(n.bid_price){r.sell.bid_price.value=n.bid_price;var t=n.bid_price.toString().split(/[\.,]+/),e=v(t,2);r.sell.bid_price.unit=e[0],r.sell.bid_price.cent=e[1]}}(),function(){if(n.is_forward_starting&&+n.date_start>+n.current_spot_time)return r.fwd_starting="* Contract has not started yet".i18n();r.fwd_starting=""}(),r.chart.manualReflow())}var x={},w={EXPIRED:"This contract has expired".i18n(),MARKET_RATE:"Note: Contract will be sold at the prevailing market price when the request is received by our servers. This price may differ from the indicated price.".i18n(),NO_RESALE:"Resale of this contract is not offered".i18n(),FINISHED:"This contract has expired".i18n()},k=null,S=t.init=function(t,o){return new Promise(function(r,e){if(x[o])return x[o].moveToTop(),void r();h.default.send({proposal_open_contract:1,contract_id:t}).then(function(t){var e=t.proposal_open_contract;void 0!==e.underlying||void 0!==e.shortcode?(e.transaction_id=o,P(e),r()):function(){if(k)k.moveToTop();else{var t="There was a market data disruption during the contract period. For real-money accounts we will attempt to correct this and settle the contract properly, otherwise the contract will be cancelled and refunded. Virtual-money contracts will be cancelled and refunded.".i18n(),e=(0,d.default)('<div class="data-disruption-dialog">'+t+"</div>");(k=s.default.createBlankWindow(e,{title:" There was an error ".i18n(),height:200,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,destroy:function(){k&&k.dialog("destroy").remove(),k=null},"data-authorized":"true"})).dialog("open"),window.dd=k}}()}).catch(function(t){e(t)})})};var L=function(t){t.proposal_open_contract.is_ended=!0,t.sell.sell_at_market_enabled=!1},T=function(t){return t.validation_error?t.validation_error:"open"!==t.status?w.FINISHED:t.is_expired||t.is_sold?w.EXPIRED:t.is_valid_to_sell?w.MARKET_RATE:t.is_valid_to_sell?void 0:w.NO_RESALE},z=function(t,e){40<e.sell.bid_prices.length&&e.sell.bid_prices.shift(),e.sell.bid_prices.push(t.bid_price)},P=function(i){require(["text!viewtransaction/viewTransaction.html"],function(t){var e=(0,d.default)(t).i18n(),r=E(i,e),o=s.default.createBlankWindow(e,{title:i.display_name+" ("+i.transaction_id+")",width:700,minWidth:630,minHeight:480,height:480,destroy:function(){},close:function(){a&&a.unbind(),h.default.proposal_open_contract.forget(i.contract_id),h.default.events.off("proposal_open_contract",M);for(var t=0;t<r.onclose.length;++t)r.onclose[t]();(0,d.default)(this).dialog("destroy").remove(),x[i.transaction_id]=void 0},open:function(){h.default.proposal_open_contract.forget(i.contract_id)},resize:function(){r.chart.manualReflow()},"data-authorized":"true"});o.dialog("open");var a=p.default.bind(e[0],r);x[i.transaction_id]=o})},E=function(t,a){var e=t.is_path_dependent&&"sold"!==t.status?t.exit_tick_time:parseInt(t.sell_time),i={route:{value:"table",update:function(t){i.route.value=t}},note:T(t),chart:{chart:null,loading:"Loading "+t.display_name+" ...",added_labels:[],hasLabel:function(t){return!!i.chart.added_labels.includes(t)||(i.chart.added_labels.push(t),!1)},type:"ticks",manualReflow:function(){if(i.chart.chart){var t=-1*(a.find(".longcode").height()+a.find(".tabs").height()+a.find(".footer").height())-16,e=a,r=e.width()-10,o=e.height();i.chart.chart.setSize(r,o+t,!1),i.chart.chart.hasUserSize=null,i.chart.chart.series[0]&&0===i.chart.chart.series[0].data.length?i.chart.chart.showLoading():i.chart.chart.hideLoading()}}},proposal_open_contract:f({},t,{currency:(t.currency||"USD")+" ",is_ended:t.is_settleable||t.is_sold||"open"!==t.status,is_sold_at_market:!1,is_sold_before_expiry:e<t.date_expiry,isLookback:_.default.isLookback(t.contract_type),lb_formula:_.default.formula(t.contract_type,t.multiplier&&formatPrice(t.multiplier,t.currency||"USD")),pip:0}),sell:{bid_prices:[],bid_price:{unit:void 0,cent:void 0,value:void 0},sell:function(){return _=a,(s=i).sell.sell_at_market_enabled=!1,require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"]),void h.default.send({sell:s.proposal_open_contract.contract_id,price:0}).then(function(t){s.proposal_open_contract.is_sold_before_expiry=!0;var l=t.sell;require(["text!viewtransaction/viewTransactionConfirm.html","css!viewtransaction/viewTransactionConfirm.css"],function(t){var e=s.proposal_open_contract,r=e.buy_price,o=e.longcode,a=e.currency,i={longcode:o,buy_price:r,sell_price:l.sold_for,return_percent:(100*(l.sold_for-r)/r).toFixed(2)+"%",transaction_id:l.transaction_id,balance:l.balance_after,currency:a},n=(0,d.default)(t).i18n();_.after(n);var c=p.default.bind(n[0],i);s.onclose.push(function(){c&&c.unbind()})})}).catch(function(t){d.default.growl.error({message:t.message})});var s,_},sell_at_market_enabled:!0},onclose:[]};return I(i,a),i},M=void 0;function A(e,t){M=function(t){if(+t.proposal_open_contract.contract_id!=+e.proposal_open_contract.contract_id)return;if(t.error)return void function(t){d.default.growl.error({message:t}),h.default.proposal_open_contract.forget(data.echo_req.contract_id),h.default.proposal_open_contract.subscribe(data.echo_req.contract_id)}(t.error.message);b(t,e)},h.default.proposal_open_contract.subscribe(t.contract_id),h.default.events.on("proposal_open_contract",M)}function R(p,e){var u=m.default.keyFor(p.proposal_open_contract.underlying,e);!function(){if(m.default[u])m.default.subscribe(u);else{var t=function(t,e){return{symbol:e,subscribe:1,granularity:t,style:0===t?"ticks":"candles"}}(e,p.proposal_open_contract.underlying);m.default.register(t).catch(function(t){d.default.growl.error({message:t.message})})}}();var t=void 0,r=void 0,o=!1;function f(){o||(o=!0,m.default.unregister(u),t&&h.default.events.off("tick",t),r&&h.default.events.off("candles",r))}p.onclose.push(f),0!==e?r=h.default.events.on("ohlc",function(t){var e=m.default.keyFor(t.ohlc.symbol,t.ohlc.granularity);if(u===e){var r=p.chart.chart;if(r){var o=r.series[0],a=o.data[o.data.length-1],i=t.ohlc,n=[1e3*i.open_time,+i.open,+i.high,+i.low,+i.close];a.x!==n[0]?o.addPoint(n,!0,!0):a.update(n,!0);var c=p.proposal_open_contract,l=c.status,s=(c.is_sold,c.exit_tick),_=c.exit_tick_time,d=c.date_expiry;(+i.epoch>+d||"open"!==l||s||_)&&f()}}}):t=h.default.events.on("tick",function(t){if(t.tick&&t.tick.symbol===p.proposal_open_contract.underlying){var e,r,o=p.chart.chart,a=p.proposal_open_contract,i=a.status,n=a.is_sold,c=a.exit_tick,l=a.exit_tick_time,s=t.tick;if(n||"open"!==i||c||l)f();else r=s,(e=o)&&e.series[0].addPoint([1e3*r.epoch,+r.quote,"gray"])}})}var C=function(t,e){var a=e.chart.chart,r=e.proposal_open_contract,o=r.barrier,i=r.high_barrier,n=r.low_barrier,c=r.tick_count;!function(t,e,r){t&&a.yAxis[0].removePlotLine("barrier");e&&a.yAxis[0].removePlotLine("high_barrier");r&&a.yAxis[0].removePlotLine("low_barrier")}(o,i,n),function(t,e,r){var o=c?"":"dot";t&&a.addPlotLineY({id:"barrier",value:t,dashStyle:o});e&&a.addPlotLineY({id:"high_barrier",value:e,dashStyle:o});r&&a.addPlotLineY({id:"low_barrier",value:r,dashStyle:o})}(o,i,n)},I=function(_,o){var t,e,r=Math.min(+_.proposal_open_contract.date_expiry,y.default.utc().unix())-(_.proposal_open_contract.purchase_time||_.proposal_open_contract.date_start),a=function(t){var e=0;e=t<=3600?0:t<=7200?60:t<=21600?120:t<=86400?300:3600;return e}(r),i=function(t,e){var r=_.proposal_open_contract,o=r.date_start,a=r.current_spot_time,i=r.purchase_time,n=r.exit_tick_time,c=void 0;if(+i<+o)c=i;else{c=!(+a<+o||+n<+o)&&+o||+i}var l=n<c||!n?"latest":+n+e,s={adjust_start_time:1,ticks_history:_.proposal_open_contract.underlying,start:c-e,end:l,style:"ticks",count:4999};0!==t&&(s.granularity=t,s.style="candles",_.chart.type="candles");return s}(a,(t=r,0===(e=a)?Math.max(3,30*t/3600|0):3*e));_.proposal_open_contract.is_ended||R(_,a),h.default.send(i).then(function(t){!function(t){_.chart.loading="";var e=function(t,e){return f({title:e},t)}(t,_.proposal_open_contract.display_name),r=function(t,e,r){var o=[],a="",i=3;if(r.history){a="line";for(var n=r.history,c=n.times,l=n.prices,s=0;s<c.length;++s)o.push([1e3*c[s],+l[s]]),i=Math.max(i,l[s].toString().substring(l[s].toString().indexOf(".")+1).length)}r.candles&&(a="candlestick",o=r.candles.map(function(t){return[1e3*t.epoch,+t.open,+t.high,+t.low,+t.close]}));var _=r.title,d=t.find(".transaction-chart")[0],p=g.getChartLabels(e.proposal_open_contract),u=e.proposal_open_contract,f=u.entry_tick_time,h=u.date_start,m=f||h,v={credits:{href:"#",text:""},chart:{type:"line",renderTo:d,backgroundColor:null,width:0,height:0,marginLeft:65,marginRight:20},title:{text:""},subtitle:{text:g.getLabelEl(p),useHTML:!0},tooltip:{useHTML:!0,formatter:function(){var t=addComma(this.y,i);return"<div class='tooltip-body'>"+y.default.utc(this.x).format("dddd, MMM D, HH:mm:ss")+" GMT<br/>"+this.series.name+" "+t+"</div>"}},xAxis:{type:"datetime",categories:null,startOnTick:!1,endOnTick:!1,min:o.length?o[0][0]:null,max:o.length?o[o.length-1][0]:null,labels:{overflow:"justify",format:"{value:%H:%M:%S}"}},yAxis:{labels:{align:"left",x:-65,y:-2,formatter:function(){return addComma(this.value,i)}},title:""},series:[{name:_,data:o,type:a,zIndex:10,zoneAxis:"x",zones:[{value:m?1e3*m:"",color:"#ccc"},{color:""},{color:"#ccc"}]}],exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1},navigator:{enabled:!0},plotOptions:{line:{marker:{radius:2}},candlestick:{lineColor:"black",color:"red",upColor:"green",upLineColor:"black",shadow:!0}},rangeSelector:{enabled:!1}},b=new Highcharts.Chart(v);return b.addPlotLineX=function(t){b.xAxis[0].addPlotLine({value:t.value,id:t.id||t.value,color:t.color||"#e98024",zIndex:0,width:t.width||2,dashStyle:t.dashStyle})},b.addPlotLineY=function(t){b.yAxis[0].addPlotLine({id:t.id,value:t.value,color:t.color||"green",zIndex:0,width:2,dashStyle:t.dashStyle})},d.chart=b}(o,_,e);_.chart.chart=r,_.chart.manualReflow()}(t),A(_,_.proposal_open_contract)}).catch(function(t){var e;e=t,_.chart.loading=e.message})};t.default={init:S}});