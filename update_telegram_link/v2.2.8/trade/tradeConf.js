define(["exports","jquery","moment","./lookback","../charts/chartingRequestMap","../charts/chartSettings","../websockets/binary_websockets","../common/rivetsExtra","text!../trade/tradeConf.html","../common/util","css!../trade/tradeConf.css"],function(t,e,i,a,r,o,n,c,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0;var f=p(e),y=p(i),l=p(a),u=p(r),b=p(n),d=p(c),_=p(s);function p(t){return t&&t.__esModule?t:{default:t}}var h=["entry_spot_tick","barrier","exit_spot_tick"];d.default.binders["tick-chart"]={priority:65,bind:function(t){var e=this.model;t.chart=new Highcharts.Chart({subtitle:{text:(0,o.getLabelEl)(h),useHTML:!0},title:"",credits:{enabled:!1},chart:{type:"line",renderTo:t,backgroundColor:null,width:400,height:144,marginLeft:20,marginTop:35,marginBottom:15},tooltip:{useHTML:!0,formatter:function(){var t=e.array[this.x-1];if(t&&t.tooltip)return"<div class='tooltip-body'>"+t.tooltip+"</div>"}},xAxis:{type:"linear",min:1,max:+t.getAttribute("tick-count")+1,labels:{enabled:!1}},yAxis:{labels:{align:"left",x:0,formatter:function(){return addComma(this.value,e.display_decimals)}},title:"",gridLineWidth:0},series:[{data:[]},{type:"scatter",marker:{enabled:!1},data:[]}],plotOptions:{scatter:{enableMouseTracking:!1}},exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1}})},routine:function(t,e){var i,a,r,o,n,c,s=this.model,l=e.length,u=s.makeBarrier(),d=s.contract_is_finished;if(u&&(i=u,t.chart.yAxis[0].removePlotLine(i.id),function(t,e){t.yAxis[0].addPlotLine({id:e.id,value:e.value,color:"green",width:2}),t.series[1].addPoint([1,+e.value])}(t.chart,i)),d)return a=s,r=e.findIndex(function(t){return t.epoch===+a.exit_tick_time}),void _(t.chart,{value:r+1,dashStyle:"Dash"});0!==l&&(n=e[(o=l)-1],t.chart.series[0].addPoint([o,n.quote]),1===l&&(c=l,_(t.chart,{value:c})));function _(t,e){t.xAxis[0].addPlotLine({value:e.value,id:e.id||e.value,color:e.color||"#e98024",width:e.width||2,dashStyle:e.dashStyle||!1})}}};function m(n,c){function r(e){var t,i,a,r=+e.epoch>=+s.entry_tick_time;if(!n.ticks.array.some(function(t){return t.epoch===+e.epoch})&&!n.ticks.contract_is_finished&&r){var o="open"!==s.status&&(u<-1||l);n.buy.barrier=s.barrier?+s.barrier:null,o&&(d(s),a=n.ticks.array.slice(),n.ticks.array=[].concat(function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(a))),-1<--u&&(l=e.epoch>=s.exit_tick_time,i=function(t){var e=y.default.utc(1e3*t.epoch).format("dddd, MMM D, HH:mm:ss"),i=c.symbol_name,a=addComma(+t.quote,n.ticks.display_decimals);return e+"<br/>"+i+" "+a}(t=e),n.ticks.array.push({quote:+t.quote,epoch:+t.epoch,number:n.ticks.array.length+1,tooltip:i}))}}var s=void 0,i=void 0,a=void 0,l=!1,u=c.tick_count,d=function(t){var e;e=c.contract_id,b.default.events.off("proposal_open_contract",i),b.default.events.off("tick",a),b.default.proposal_open_contract.forget(e),n.ticks.contract_is_finished=!0,n.ticks.exit_tick_time=t.exit_tick_time?t.exit_tick_time:null,n.ticks.status=t.status,n.buy.update(),n.back.visible=!0};i=b.default.events.on("proposal_open_contract",function(t){t.proposal_open_contract.contract_id!==c.contract_id||(t.error?e(t):s=t.proposal_open_contract)});var o=[],_=void 0,p=!1;a=b.default.events.on("tick",function(t){if(!(c.symbol!==t.tick.symbol)){_=_||t.tick.epoch;var e,i,a=s&&s.entry_tick_time;if(a)+a<+_&&(p=!0,e=_=a,i=c.symbol,b.default.send({ticks_history:i,end:"latest",start:e,style:"ticks",count:5e3}).then(function(i){p=!1,i.history.prices.forEach(function(t,e){o.push({epoch:i.history.times[e],quote:t,symbol:c.symbol})}),o.sort(function(t,e){return t.epoch-e.epoch})}).catch(function(t){return f.default.growl.error({message:data.error.message})})),p?o.push(t.tick):(0<o.length&&(o.forEach(function(t){return r(t)}),o=[]),r(t.tick));else o.push(t.tick)}});var e=function(t){f.default.growl.error({message:t.error.message}),b.default.proposal_open_contract.forget(t.echo_req.contract_id),b.default.proposal_open_contract.subscribe(t.echo_req.contract_id)}}var v=t.init=function(t,i,e,a){var r=u.default.digits_after_decimal(i.pip,i.symbol),o=(0,f.default)(_.default).i18n(),n=t.buy,c={title:{text:"Contract Confirmation".i18n()},buy:{barrier:null,message:n.longcode,balance_after:n.balance_after,buy_price:(+n.buy_price).toFixed(currencyFractionalDigits()),purchase_time:n.purchase_time,start_time:n.start_time,transaction_id:n.transaction_id,payout:(+n.payout).toFixed(currencyFractionalDigits()),currency:i.currency,potential_profit:(n.payout-n.buy_price).toFixed(currencyFractionalDigits()),potential_profit_text:"Profit".i18n(),show_result:!1},spreads:{amount_per_point:n.amount_per_point||"0",stop_loss_level:n.stop_loss_level||"0",stop_profit_level:n.stop_profit_level||"0"},ticks:{array:[],contract_is_finished:!1,display_decimals:r,exit_tick_time:null,is_path_dependent:null,makeBarrier:function(){var t=c.buy.barrier;return t?{value:+t}:null},tick_count:i.tick_count,value:(i.digits_value||"0")+"",category:i.category,category_display:i.category_display,status:"waiting",chart_visible:i.show_tick_chart},arrow:{visible:!i.show_tick_chart&&"digits"!==i.category.contract_category},back:{visible:!1}};l.default.isLookback(i.category_display.contract_type)&&(c.buy.payout=l.default.formula(i.category_display.contract_type,i.amount),c.buy.potential_profit=void 0),c.buy.update=function(){var t=c.ticks.status;c.title.text={waiting:"Contract Confirmation".i18n(),won:"This contract won".i18n(),lost:"This contract lost".i18n()}[t],"lost"===t&&(c.buy.potential_profit=(-c.buy.buy_price).toFixed(currencyFractionalDigits()),c.buy.payout=(0).toFixed(currencyFractionalDigits()),c.buy.potential_profit_text="Lost"),"won"===t&&(c.buy.balance_after=+n.balance_after+ +c.buy.payout,b.default.sell_expired()),c.buy.show_result=!0},c.back.onclick=function(){return a(o)},c.arrow.onclick=function(t){var e=(0,f.default)(t.target);e.hasClass("disabled")||(e.addClass("disabled"),require(["viewtransaction/viewTransaction"],function(t){t.init(i.contract_id,i.transaction_id).then(function(){return e.removeClass("disabled")})}))};d.default.bind(o[0],c);c.arrow.visible?(c.back.visible=!0,b.default.events.on("balance",function(t){if(local_storage.get("authorize")){var e=local_storage.get("authorize").loginid;t.balance&&t.balance.loginid===e&&c.buy.balance_after!==t.balance.balance&&(c.buy.balance_after=t.balance.balance)}})):m(c,i),e(o)};t.default={init:v}});