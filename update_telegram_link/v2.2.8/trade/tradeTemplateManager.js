define(["exports","jquery","charts/chartWindow","common/rivetsExtra","lodash"],function(e,t,a,n,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0;var m=u(t),o=(u(a),u(n)),l=u(r);function u(e){return e&&e.__esModule?e:{default:e}}var i=function(e,t,a){return t&&s(e.prototype,t),a&&s(e,a),e};function s(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}require(["text!trade/tradeTemplateManager.html"]),local_storage.get("trade-templates")||local_storage.set("trade-templates",[]);var c=(i(d,[{key:"init_state",value:function(t,o){var u=this,e={route:{value:"menu"},menu:{},templates:{array:local_storage.get("trade-templates"),save_as_value:"",rename_tmpl:null,rename_value:"",current:null}},i=e.route,s=e.templates,n=e.menu,a=this.setRandom(o.get_template());return s.array=local_storage.get("templates"),-1!==l.default.findIndex(s.array,function(e){return e.random===a.random})&&(s.current=a),i.update=function(e){i.value=e},n.save_as=function(){var e=o.get_template();e.name=e.categories_value.contract_category_display+" "+l.default.capitalize(e.categoriy_displays_selected.name),s.save_as_value=e.name,i.update("save-as")},n.templates=function(){s.array=local_storage.get("trade-templates"),i.update("templates")},n.save_changes=function(){var e=u.setRandom(o.get_template()),t=e.name,a=local_storage.get("trade-templates"),n=l.default.findIndex(a,function(e){return e.name===t});-1!==n?a[n]=e:a.push(e),local_storage.set("trade-templates",a),s.array=a,s.current=e,m.default.growl.notice({message:"Template changes saved ".i18n()+"("+e.name+")"})},n.open_file_selector=function(e){(0,m.default)(t).find("input[type=file]").click()},n.upload=function(e){var o=u,t=e.target.files[0];if(e.target.value=null,t){var a=new FileReader;a.onload=function(e){var t=e.target.result,a=local_storage.get("trade-templates"),n=null;try{if((n=JSON.parse(t)).name=n.name.substring(0,20).replace(/[<>]/g,"-"),n.random!==(n=o.setRandom(n)).random)throw"Invalid JSON file".i18n();if(o.isDuplicate(n,a))return;if("trade-template"!==n.template_type)throw"Invalid template type.".i18n()}catch(e){return void m.default.growl.error({message:e})}for(var r=1,l=n.name;;){if(!a.map(function(e){return e.name}).includes(l)){n.name=l;break}l=n.name+" ("+r+")",r++}s.apply(n),a.push(n),local_storage.set("trade-templates",a),s.array=a,m.default.growl.notice({message:"Successfully applied the template and saved it as ".i18n()+"<b>"+n.name+"</b>"})},a.readAsText(t)}},s.save_as=function(e){e.preventDefault();var t=s.save_as_value.substring(0,20).replace(/[<>]/g,"-"),a=u.setRandom(o.get_template());if(a){a.name=t;var n=local_storage.get("trade-templates");if(n.map(function(e){return e.name}).includes(t))return void m.default.growl.error({message:"Template name already exists".i18n()});if(u.isDuplicate(a,n))return;n.push(a),s.current=a,local_storage.set("trade-templates",n),s.array=n,i.update("menu"),o.set_template(a)}},s.download=function(e){var t=JSON.stringify(e);downloadFileInBrowser(e.name+".json","text/json;charset=utf-8;",t),m.default.growl.notice({message:"Downloading template as <b>".i18n()+e.name+".json</b>"})},s.remove=function(t){var e=local_storage.get("trade-templates");s.array=e.filter(function(e){return e.name!==t.name}),local_storage.set("trade-templates",s.array),s.current&&t.name===s.current.name&&(s.current=null)},s.rename=function(e){s.rename_value=e.name,s.rename_tmpl=e,i.update("rename")},s.do_rename=function(e){e.preventDefault();var t=s.rename_tmpl.name,a=s.rename_value.substring(0,20).replace(/[<>]/g,"-"),n=local_storage.get("trade-templates");if(n.map(function(e){return e.name}).includes(a))m.default.growl.error({message:"Template name already exists".i18n()});else{var r=n.find(function(e){return e.name===t});if(r){r.name=a,local_storage.set("trade-templates",n),s.array=n,i.update("templates");var l=u.setRandom(o.get_template());l.random==r.random&&(l.name=a,o.set_template(l),s.current=l)}}},s.apply=function(e){o.set_template(e),s.current=e,i.update("menu"),o.hide_template_menu()},s.confirm=function(e,t){i.update("confirm");var a=t.currentTarget.text;s.confirm_prevMenu=a==="Delete".i18n()?"templates":"menu",s.confirm_text=a==="Delete".i18n()?"Are you sure you want to delete template?".i18n():"Are you sure you want to overwrite current template?".i18n(),s.confirm_yes=function(){a==="Delete".i18n()?(s.remove(e),s.current===e&&(s.current=null)):n.save_changes(),s.confirm_no()},s.confirm_no=function(){i.update(s.confirm_prevMenu)}},e}},{key:"setRandom",value:function(e){var t=e.name;return delete e.name,delete e.random,e.template_type="trade-template",e.random=this.hashCode(JSON.stringify(e)),e.name=t,e}},{key:"hashCode",value:function(e){return e.split("").reduce(function(e,t){return(e=(e<<5)-e+t.charCodeAt(0))&e},0)}},{key:"isDuplicate",value:function(e,t){var a=l.default.find(t,["random",e.random]);return!!a&&(m.default.growl.error({message:"Template already saved as ".i18n()+"<b>"+a.name+"</b>."}),!0)}},{key:"unbind",value:function(){this.view&&this.view.unbind(),this.view=null}}]),d);function d(t,e){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d);var n=this,r=local_storage.get("trade-templates");r.forEach(function(e){e.random&&e.template_type||(e=n.setRandom(e))}),local_storage.set("trade-templates",r);var l=this.init_state(t,e);require(["text!trade/tradeTemplateManager.html"],function(e){t.append(e.i18n()),a.view=o.default.bind(t[0],l)})}var p=e.init=function(e,t){return new c(e,t)};e.default={init:p}});