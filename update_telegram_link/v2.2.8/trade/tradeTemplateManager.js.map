{"version":3,"sources":["../../../../src/trade/tradeTemplateManager.es6"],"names":["require","local_storage","get","set","TradeTemplateManager","root","dialog","_this","templates","forEach","tmpl","random","template_type","setRandom","state","init_state","append","html","i18n","view","rv","bind","route","value","menu","array","save_as_value","rename_tmpl","rename_value","current","current_tmpl","get_template","_","findIndex","t","update","save_as","name","categories_value","contract_category_display","capitalize","categoriy_displays_selected","save_changes","inx","push","$","growl","notice","message","open_file_selector","event","find","click","upload","file","target","files","reader","FileReader","onload","e","contents","result","data","JSON","parse","substring","replace","hash","isDuplicate","error","map","includes","apply","readAsText","preventDefault","set_template","download","json","stringify","console","log","downloadFileInBrowser","remove","filter","rename","do_rename","new_name","hide_template_menu","confirm","action","currentTarget","text","confirm_prevMenu","confirm_text","confirm_yes","confirm_no","hashCode","s","split","reduce","a","b","charCodeAt","tmpl_copy","unbind","init"],"mappings":"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","file":"tradeTemplateManager.js","sourcesContent":["/**\n * Created by amin on July 31, 2016.\n */\nimport $ from 'jquery';\nimport chartWindow from 'charts/chartWindow';\nimport rv from 'common/rivetsExtra';\nimport _ from 'lodash';\n\nrequire(['text!trade/tradeTemplateManager.html']);\n\nif(!local_storage.get('trade-templates')) {\n  local_storage.set('trade-templates', []);\n}\n\nclass TradeTemplateManager {\n  constructor(root, dialog) {\n    const _this = this;\n    const templates = local_storage.get(\"trade-templates\");\n    templates.forEach(function(tmpl){\n      if(!tmpl.random || !tmpl.template_type){\n        tmpl = _this.setRandom(tmpl);\n      }\n    });\n    local_storage.set(\"trade-templates\", templates);\n    const state = this.init_state(root, dialog);\n    require(['text!trade/tradeTemplateManager.html'], html => {\n      root.append(html.i18n());\n      this.view = rv.bind(root[0], state);\n    });\n  }\n\n  init_state(root, dialog) {\n    const state = {\n      route: { value: 'menu' },\n      menu: {\n      },\n      templates: {\n        array: local_storage.get('trade-templates'),\n        save_as_value: '',\n        rename_tmpl: null,\n        rename_value: '',\n        current: null,\n      }\n    };\n    const {route, templates, menu} = state;\n\n    /* persist applied templates between page reloads */\n    const current_tmpl = this.setRandom(dialog.get_template());\n    templates.array = local_storage.get(\"templates\");\n    if(_.findIndex(templates.array, t => t.random === current_tmpl.random) !== -1) {\n      templates.current = current_tmpl;\n    }\n\n    route.update = value => {\n      route.value = value;\n    };\n\n    menu.save_as = () => {\n      const tmpl = dialog.get_template();\n      tmpl.name = `${tmpl.categories_value.contract_category_display} ${_.capitalize(tmpl.categoriy_displays_selected.name)}`;\n      templates.save_as_value = tmpl.name;\n      route.update('save-as');\n    }\n\n    menu.templates = () => {\n      templates.array = local_storage.get('trade-templates'); // it can be modified from other dialogs.\n      route.update('templates');\n    }\n\n    menu.save_changes = () => {\n      const current = this.setRandom(dialog.get_template());\n      const name = current.name;\n      const array = local_storage.get('trade-templates');\n      const inx = _.findIndex(array, t => t.name === name);\n      if(inx !== -1) {\n        array[inx] = current;\n      } else {\n        array.push(current);\n      }\n      local_storage.set('trade-templates', array);\n      templates.array = array;\n      templates.current = current;\n      $.growl.notice({message: 'Template changes saved '.i18n() + '(' + current.name + ')'});\n    }\n\n    menu.open_file_selector = (event) => {\n      $(root).find(\"input[type=file]\").click();\n    }\n\n    menu.upload = (event) => {\n      const _this = this;\n      const file = event.target.files[0];\n      event.target.value = null;\n      if(!file)\n        return;\n\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        const contents = e.target.result;\n        const array = local_storage.get(\"trade-templates\");\n        let data = null;\n        try{\n          data = JSON.parse(contents);\n          data.name = data.name.substring(0,20).replace(/[<>]/g,\"-\");\n          const hash = data.random;\n          data = _this.setRandom(data);\n          if(hash !== data.random){\n            throw \"Invalid JSON file\".i18n();\n          }\n          if(_this.isDuplicate(data, array)){\n            return;\n          }\n          if(data.template_type !== 'trade-template') {\n            throw \"Invalid template type.\".i18n();\n          }\n        } catch(e){\n          $.growl.error({message:e});\n          return;\n        }\n\n        // Rename duplicate template names.\n        let file = 1,\n            name = data.name;\n        while(1){\n          if(array.map(t => t.name).includes(name)) {\n            name = data.name + \" (\" + file + \")\"\n            file++;\n            continue;\n          }\n          data.name = name;\n          break;\n        }\n\n        templates.apply(data);\n        array.push(data);\n        local_storage.set('trade-templates', array);\n        templates.array = array;\n        $.growl.notice({message: \"Successfully applied the template and saved it as \".i18n() + \"<b>\" + data.name + \"</b>\"});\n      }\n\n      reader.readAsText(file);\n    }\n\n    templates.save_as = (event) => {\n      event.preventDefault();\n      const name = templates.save_as_value.substring(0,20).replace(/[<>]/g,\"-\");\n      const tmpl = this.setRandom(dialog.get_template());\n      if(tmpl) {\n        tmpl.name = name;\n        const array = local_storage.get('trade-templates');\n        if(array.map(t => t.name).includes(name)) {\n          $.growl.error({message: 'Template name already exists'.i18n() });\n          return;\n        }\n\n        if(this.isDuplicate(tmpl, array)){\n          return;\n        }\n        array.push(tmpl);\n        templates.current = tmpl;\n        local_storage.set('trade-templates', array);\n        templates.array = array;\n        route.update('menu');\n        dialog.set_template(tmpl);\n      }\n    }\n\n    templates.download = (tmpl) => {\n      var json = JSON.stringify(tmpl);\n      console.log(tmpl);\n      downloadFileInBrowser(tmpl.name + '.json', 'text/json;charset=utf-8;', json);\n      $.growl.notice({message: \"Downloading template as <b>\".i18n() + tmpl.name + \".json</b>\"});\n    }\n\n    templates.remove = (tmpl) => {\n      let array = local_storage.get('trade-templates');\n      templates.array = array.filter(t => t.name !== tmpl.name);\n      local_storage.set('trade-templates', templates.array);\n      if(templates.current && tmpl.name === templates.current.name) {\n        templates.current = null;\n      }\n    }\n\n    templates.rename = tmpl => {\n      templates.rename_value = tmpl.name;\n      templates.rename_tmpl = tmpl;\n      route.update('rename');\n    }\n\n    templates.do_rename = (event) => {\n      event.preventDefault();\n      const name = templates.rename_tmpl.name;\n      const new_name = templates.rename_value.substring(0,20).replace(/[<>]/g,\"-\");\n      const array = local_storage.get('trade-templates');\n      if(array.map(t => t.name).includes(new_name)) {\n          $.growl.error({message: 'Template name already exists'.i18n() });\n          return;\n      };\n      const tmpl = array.find(t => t.name === name);\n      if(tmpl) {\n        tmpl.name = new_name;\n        local_storage.set('trade-templates', array);\n        templates.array = array;\n        route.update('templates');\n\n        /* update template name in current dialog */\n        const current = this.setRandom(dialog.get_template());\n        if(current.random == tmpl.random) {\n          current.name = new_name\n          dialog.set_template(current);\n          templates.current = current;\n        }\n      }\n    }\n\n    templates.apply = tmpl => {\n      dialog.set_template(tmpl);\n      templates.current = tmpl;\n      route.update('menu');\n      dialog.hide_template_menu();\n    }\n\n    templates.confirm = (tmpl, event) => {\n      route.update(\"confirm\");\n      const action = event.currentTarget.text;\n      templates.confirm_prevMenu = action === \"Delete\".i18n() ? \"templates\" : \"menu\";\n      templates.confirm_text = action === \"Delete\".i18n() ? \"Are you sure you want to delete template?\".i18n() : \"Are you sure you want to overwrite current template?\".i18n();\n\n      templates.confirm_yes = () => {\n        if(action === \"Delete\".i18n()) {\n          templates.remove(tmpl)\n          if(templates.current === tmpl)\n            templates.current = null;\n        }\n        else {\n          menu.save_changes();\n        }\n        templates.confirm_no();\n      }\n\n      templates.confirm_no = () => {\n        route.update(templates.confirm_prevMenu);\n      }\n    }\n\n    return state;\n  }\n\n  setRandom(tmpl) {\n    const name = tmpl.name;\n    delete tmpl.name;\n    delete tmpl.random;\n    tmpl.template_type = 'trade-template';\n    tmpl.random = this.hashCode(JSON.stringify(tmpl));\n    tmpl.name = name;\n    return tmpl;\n  }\n\n  hashCode(s) {\n    return s.split(\"\").reduce(function(a,b){a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);\n  }\n\n  isDuplicate(tmpl, array){\n    // get template with same values.\n    const tmpl_copy = _.find(array, ['random', tmpl.random]);\n    if(tmpl_copy){\n      $.growl.error({message: 'Template already saved as '.i18n() +'<b>' + tmpl_copy.name + '</b>.'});\n      return true;\n    }\n    return false;\n  }\n\n  unbind() {\n    this.view && this.view.unbind();\n    this.view = null;\n  }\n}\n\nexport const init = (root, dialog) => new TradeTemplateManager(root, dialog);\nexport default { init, };\n"]}