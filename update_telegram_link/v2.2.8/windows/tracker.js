define(["exports","../windows/windows","../websockets/binary_websockets","lodash","../navigation/menu"],function(e,t,i,o,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.is_empty=e.reopen_unique_dialogs=e.get_unique_dialogs=e.get_trade_dialogs=e.reopen_trade_dialogs=e.reopen=e.track=void 0;d(t);var s=d(i),u=d(o),a=d(n);function d(e){return e&&e.__esModule?e:{default:e}}function r(){return new Promise(function(e){if(s.default.is_authenticated())return e();s.default.events.on_till("login",function(){return e(),!0})})}function l(o,e){function i(a,e){if("closed"!==a.position.mode)if(a.is_unique)a.is_authorized?r().then(function(){return $(n[e]).click(),!0}):$(n[e]).click();else if("chartWindow"===e){var t=a.data.instrumentCode,i=u.default.find(o.instruments,function(e){return e.symbol==t});if(a.data.instrumentName=i.display_name,0<o.length&&-1===o.indexOf(t))return;a.data.tracker_id=++d,require(["charts/chartWindow"],function(e){a.data.isTrackerInitiated=!0,e.addNewWindow(a.data)})}else"tradeDialog"===e&&r().then(function(){return a.data.tracker_id=++d,s.default.send({contracts_for:a.data.symbol.symbol}).then(function(n){require(["trade/tradeDialog"],function(e){var t=e.init(a.data.symbol,n.contracts_for,a.data.template,!0);if(a.position.offset){var i=a.position.offset.left,o=a.position.offset.top;t.dialog("widget").css({left:i+"px",top:o+"px"}),t.trigger("animated"),t.dialog("option","position",{my:i,at:o})}})}).catch(void 0),!0})}var n={assetIndex:"#nav-menu .assetIndex",statement:"#nav-menu .statement",tradingTimes:"#nav-menu .tradingTimes",historicalData:"#nav-menu .historical-data",portfolio:"#nav-menu .portfolio",profitTable:"#nav-menu .profitTable",token:"#nav-menu .token-management",deposit:"#nav-menu .deposit",withdraw:"#nav-menu .withdraw",copyTrade:"#nav-menu .copytrade"},d=0;u.default.forEach(e,function(e,t){u.default.isArray(e)?e.forEach(function(e){return i(e,t)}):u.default.isObject(e)&&i(e,t)})}var f=local_storage.get("states")||{},m={},c=s.default.cached.send({trading_times:(new Date).toISOString().slice(0,10)}).then(function(e){var t=a.default.extractChartableMarkets(e),i=(0,u.default)(t).map("submarkets").flatten().map("instruments").flatten().map("symbol").value();return i.instruments=(0,u.default)(t).map("submarkets").flatten().map("instruments").flatten().value(),i}).catch(function(e){return[]}),p=u.default.debounce(function(){if(s.default.is_authenticated()){var e=local_storage.get("states");f.name=e&&e.name||f.name,local_storage.set("states",f)}},50),_=e.track=function(e,n){var a=n.dialog("widget"),d=null,s={module_id:e.module_id,is_unique:e.is_unique,is_authorized:"true"===n.attr("data-authorized"),data:e.data,position:{size:{width:n.dialog("option","width"),height:n.dialog("option","height")},offset:void 0,mode:"normal"}};if(e.is_unique)f[e.module_id]=s,(d=m[e.module_id])&&("closed"===d.position.mode&&(d=null),delete m[e.module_id]);else if(f[e.module_id]=f[e.module_id]||[],f[e.module_id].push(s),m[e.module_id]&&void 0!==s.data.tracker_id){var t=u.default.findIndex(m[e.module_id],function(e){return e.data.tracker_id===s.data.tracker_id});-1!==t&&(d=m[e.module_id][t],m[e.module_id].splice(t,1),"closed"===d.position.mode&&(d=null))}return p(),a.on("dragstop",function(){s.position.offset=a.offset(),p()}),a.on("animated",function(){s.position.offset=a.offset(),p()}),a.on("resizestop",function(e,t){s.position.size=t.size,s.position.offset=a.offset(),p()}),n.on("dialogextendminimize",function(){s.position.mode="minimized",p()}),n.on("dialogextendmaximize",function(){s.position.mode="maximized",p()}),n.on("dialogextendrestore",function(){a.draggable({containment:!1}),s.position.offset=a.offset(),s.position.mode="normal",p()}),n.on("dialogdestroy",function(){if(n.dialogExtend("restore"),s.is_unique)delete f[s.module_id];else if(f[s.module_id]){var e=f[s.module_id].indexOf(s);1==f[s.module_id].length?delete f[s.module_id]:f[s.module_id].splice(e,1)}p()}),n.on("dialogclose",function(){n.dialogExtend("restore"),s.position.mode="closed",p()}),n.on("dialogopen",function(){var e,t,i,o;s.position.offset=a.offset(),s.position.mode="normal",p(),d&&(e=a,t=n,i=s,(o=d.position).size&&t.dialog("option","width",o.size.width),o.size&&t.dialog("option","height",o.size.height),i.position.size=o.size,i.position.mode=o.mode,"maximized"===o.mode?setTimeout(function(){t.dialogExtend("maximize"),t.dialog("moveToTop")},10):"minimized"===o.mode&&t.dialogExtend("minimize"),o.offset&&(e.css({left:o.offset.left+"px",top:o.offset.top+"px"}),i.position.offset=o.offset),p(),d=null)}),function(e){s.data=e,p()}},g=e.reopen=function(e){var t=0<arguments.length&&void 0!==e?e:null;t&&(f=t),c.then(function(e){m=f,f={},p(),l(e,m)})},h=e.reopen_trade_dialogs=function(t){c.then(function(e){l(e,{tradeDialog:t})})},v=e.get_trade_dialogs=function(){return u.default.cloneDeep(f.tradeDialog||[])},w=e.get_unique_dialogs=function(){return u.default.filter(f,{is_unique:!0})},x=e.reopen_unique_dialogs=function(e){var t={};u.default.forEach(e,function(e){t[e.module_id]=t[e.module_id]||[],e.position.mode="normal",t[e.module_id].push(e)}),l(null,t)},z=e.is_empty=function(){return 0===u.default.values(f).filter(function(e){return!u.default.isString(e)&&(u.default.isArray(e)||"closed"!==e.position.mode)}).length};e.default={track:_,reopen:g,reopen_trade_dialogs:h,get_trade_dialogs:v,is_empty:z,get_unique_dialogs:w,reopen_unique_dialogs:x}});