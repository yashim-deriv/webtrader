{"version":3,"sources":["../../../../src/token/token.es6"],"names":["token_win","token_win_view","rv","binders","routine","el","text","clip","clipboard","trigger","on","$","growl","notice","message","error","i18n","_rv_clipboard_","destroy","unbind","init_state","root","state","route","search_input","tokens","token","name","scopes","read","trade","payments","admin","btn_disabled","checkTokenName","e","scope","token_name","length","substr","match","replace","test","confirm","visible","top","tokens_filtered","txt","toLowerCase","filter","display_name","indexOf","permissions","show","span","target","position","parent","height","attr","no","yes","liveapi","send","api_token","delete_token","then","data","update_tokens","catch","err","change_route","forEach","join","last_used_tooltip","last_used","moment","utc","fromNow","add","request","new_token","new_token_scopes","push","error_msg","cached","authorize","console","bind","initTokenWin","windows","createBlankWindow","title","resizable","collapsable","minimizable","maximizable","width","minHeight","close","track","module_id","is_unique","dialog","init","$menuLink","click","html","moveToTop"],"mappings":"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","file":"token.js","sourcesContent":["/* created by apoorv, on Jan 31 2017 */\nimport liveapi from 'websockets/binary_websockets';\nimport windows from 'windows/windows';\nimport rv from 'common/rivetsExtra';\nimport moment from 'moment';\nimport clipboard from 'clipboard';\nimport html from 'text!token/token.html';\nimport {find} from 'lodash';\nimport 'css!token/token.css';\n\nlet token_win = null;\nlet token_win_view = null;\n\n/* rivetjs clipboard copy binder */\nrv.binders['clipboard'] = {\n    routine: (el, text) => {\n        const clip = new clipboard(el, {\n            text: (trigger) => {\n                return text;\n            }\n        });\n\n        clip.on('success', () => {\n            $.growl.notice({ message: 'Copied \"' + text + '\"' });\n        });\n\n        clip.on('error', () => {\n            $.growl.error({ message: 'Your browser doesn\\'t support copy to clipboard'.i18n() });\n        });\n\n        el._rv_clipboard_ && el._rv_clipboard_.destroy();\n        el._rv_clipboard_ = clip;\n    },\n    unbind: (el) => {\n        el._rv_clipboard_.destroy();\n    }\n};\n\nconst init_state = (root) => {\n    const state = {\n        route: 'token-list',\n        search_input: '',\n        tokens: [],\n        token: {\n            name: '',\n            scopes: {\n                read: true,\n                trade: false,\n                payments: false,\n                admin: false\n            },\n            btn_disabled: false,\n            checkTokenName: (e,scope) => {\n              let token_name = scope.token.name;\n              if(token_name.length > 32){\n                $.growl.error({message:\"Token name can have a maximum of 32 characters\".i18n()});\n                scope.token.name = token_name.substr(0,32);\n              }\n              if(token_name.match(/[^\\w\\s]+/g) != null){\n                $.growl.error({message:\"Token name can contain alphanumeric characters with spaces and underscores\".i18n()});\n                scope.token.name = token_name.replace(/[^\\w\\s]+/g, \"\");\n              }\n              if(!/^[\\w]/.test(token_name)){\n                $.growl.error({message:\"Token name should begin with alphanumeric characters only\".i18n()});\n                scope.token.name = token_name.replace(/^[^\\w]+/g, \"\");\n              }\n            }\n        },\n        confirm: {\n            visible: false,\n            top: '0px',\n            token: {}\n        }\n    };\n\n    state.tokens_filtered = () => {\n        const txt = state.search_input.toLowerCase();\n        return state.tokens.filter((token) => {\n            return txt === '' || token.display_name.toLowerCase().indexOf(txt) !== -1 || token.token.toLowerCase().indexOf(txt) !== -1 || token.permissions.toLowerCase().indexOf(txt) !== -1;\n        });\n    }\n\n    state.confirm.show = (e) => {\n        const span = $(e.target);\n        const top = span.position().top - span.parent().parent().height();\n        let token = span.attr('token-id');\n        token = find(state.tokens, { token: token });\n        state.confirm.top = top + 'px';\n        state.confirm.visible = true;\n        state.confirm.token = token;\n\n    }\n    state.confirm.no = () => {\n        state.confirm.visible = false;\n    }\n    state.confirm.yes = () => {\n        const token = state.confirm.token;\n        state.confirm.visible = false;\n        liveapi.send({ api_token: 1, delete_token: token.token })\n            .then((data) => {\n                const tokens = (data.api_token && data.api_token.tokens) || [];\n                state.update_tokens(tokens);\n            })\n            .catch((err) => {\n                $.growl.error({ message: err.message });\n            });\n    }\n\n    state.change_route = (route) => {\n        if (route !== 'token-list')\n            state.confirm.visible = false;\n        state.route = route;\n    }\n    state.update_tokens = (tokens) => {\n        tokens.forEach((token) => {\n            const scopes = token.scopes;\n            token.permissions = scopes.length == 4 ? 'All' : scopes.join(', ');\n\n            token.last_used_tooltip = token.last_used;\n            token.last_used = token.last_used ? moment.utc(token.last_used, 'YYYY-MM-DD HH:mm:ss').fromNow() : '-';\n        });\n        state.tokens = tokens;\n    }\n\n    state.token.add = () => {\n        if(state.token.name.length < 2){\n          $.growl.error({message:\"Token name must contain atleast 2 characters\".i18n()});\n          return;\n        }\n\n        const request = {\n            api_token: 1,\n            new_token: state.token.name,\n            new_token_scopes: []\n        };\n\n        state.token.scopes.read && request.new_token_scopes.push('read');\n        state.token.scopes.trade && request.new_token_scopes.push('trade');\n        state.token.scopes.payments && request.new_token_scopes.push('payments');\n        state.token.scopes.admin && request.new_token_scopes.push('admin');\n\n        let error_msg = '';\n\n        if (!request.new_token_scopes.length)\n            error_msg = 'Please choose at least one token scope'.i18n();\n        if (!request.new_token || !request.new_token.length)\n            error_msg = 'Please enter the token name'.i18n();\n\n        if (error_msg) {\n            $.growl.error({ message: error_msg });\n            return;\n        }\n\n        state.token.btn_disabled = true;\n        liveapi.cached.authorize().then(() => {\n            liveapi.send(request).then((data) => {\n                state.token.name = '';\n                state.token.btn_disabled = false;\n                $.growl.notice({ message: `${'Successfully added new token '.i18n()} ${request.new_token}` });\n    \n                const tokens = (data.api_token && data.api_token.tokens) || [];\n                state.update_tokens(tokens);\n\n                state.change_route('token-list');\n            }).catch((err) => {\n                state.token.btn_disabled = false;\n                $.growl.error({ message: err.message });\n                console.error(err);\n            });\n        })\n        .catch((err) => {\n            $.growl.error({ message: err.message });\n        });\n    }\n\n    token_win_view = rv.bind(root[0], state);\n    return liveapi.send({ api_token: 1 })\n        .then((data) => {\n            const tokens = (data.api_token && data.api_token.tokens) || [];\n            state.update_tokens(tokens);\n        })\n        .catch((err) => {\n            $.growl.error({ message: err.message });\n            console.error(err);\n        });\n}\n\nconst initTokenWin = (root) => {\n    root = $(root).i18n();\n    token_win = windows.createBlankWindow(root, {\n        title: 'Token management'.i18n(),\n        resizable: false,\n        collapsable: false,\n        minimizable: true,\n        maximizable: false,\n        width: 700,\n        minHeight: 60,\n        'data-authorized': true,\n        close: () => {\n            token_win_view && token_win_view.unbind();\n            token_win_view = null;\n            token_win.destroy();\n            token_win = null;\n        }\n    });\n    token_win.track({\n        module_id: 'token',\n        is_unique: true,\n        data: null\n    });\n    init_state(root).then(() => {\n        token_win.dialog('open');\n    })\n}\n\nexport const init = ($menuLink) => {\n    $menuLink.click(() => {\n        if (!token_win)\n            initTokenWin(html);\n        else\n            token_win.moveToTop();\n    });\n}\n\nexport default {\n    init\n}\n"]}